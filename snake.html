<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Snake</title>
  <style>
    pre {
      font-family: 'Courier New', Courier, monospace;
      line-height: 0.6;
      font-size: 2em;
    }
  </style>
</head>

<body>
  <pre></pre>

  <script>
    let opposite = {
      "left": "right",
      "right": "left",
      "up": "down",
      "down": "up",
    }
    class Snake {
      constructor(x, y, direction) {
        this.x = x;
        this.y = y;
        this.direction = direction;
      }
      samePos(other) {
        return this.x == other.x && this.y == other.y;
      }
    }
    class Apple {
      constructor(x, y) {
        this.x = x;
        this.y = y;
      }
      samePos(other) {
        return this.x == other.x && this.y == other.y;
      }
    }
    class Game {
      constructor(width = 20, height = 20) {
        this.width = width
        this.height = height
        this.snake = [];
        this.apples = [];
        this.intervalID = 0;
        this.speed = 1;
        this.status = "pre"
      }
      init() {
        this.snake = [];
        this.apples = [];
        this.speed = 2;
        this.snake.push(new Snake(3, 3, "right"))
        this.snake.push(new Snake(2, 3, "right"))
        this.apples.push(this.generateApple());
      }
      generateApple() {
        let x = Math.floor(Math.random() * this.width)
        let y = Math.floor(Math.random() * this.height)
        let apple = new Apple(x, y);
        for (let s of this.snake) {
          if (s.samePos(apple)) {
            return this.generateApple();
          }
        }
        return apple;
      }
      next() {
        let grow = 0;
        let head = this.snake[0];
        let newHead = new Snake(head.x, head.y, head.direction);
        switch (head.direction) {
          case "left":
            newHead.x--;
            break;
          case "right":
            newHead.x++;
            break;
          case "up":
            newHead.y--;
            break;
          case "down":
            newHead.y++;
            break;
        }
        if (newHead.x < 0 || newHead.x >= this.width || newHead.y < 0 || newHead.y >= this.height) {
          this.gameOver()
          return
        }
        for (let apple of this.apples) {
          if (newHead.samePos(apple)) {
            grow = 1;
            this.apples.splice(this.apples.indexOf(apple), 1);
            this.apples.push(this.generateApple());
            this.speed++;
            clearInterval(game.intervalID);
            game.run();
          }
        }
        for (let s of this.snake) {
          if (newHead.samePos(s)) {
            console.log(newHead, s)
            this.gameOver()
          }
        }
        if (!grow) {
          this.snake.pop();
        }
        this.snake.unshift(newHead);

        this.print()
      }

      run() {
        this.status = "play"
        this.intervalID = setInterval(() => {
          this.next()
        }, 1000 / Math.log2(1 + this.speed));
      }

      gameOver() {
        this.status = "over"
        console.log("Game Over!")
        clearInterval(this.intervalID)
      }

      toString() {
        let resultArr = new Array(this.height).fill(0).map(row => new Array(this.width).fill(" "))
        for (let s of this.snake) {
          resultArr[s.y][s.x] = "■";
          // resultArr[s.y][s.x] = "█";
        }
        for (let a of this.apples) {
          resultArr[a.y][a.x] = "o";
        }
        if (this.status == "over") {
          let endSign = "GAME OVER!";
          let endSign2 = "Press Enter";
          let startRow = Math.floor(this.height / 2) - 1
          let startCol = Math.floor((this.width - 10) / 2)
          for (let i = 0; i < endSign.length; i++) {
            resultArr[startRow][startCol + i] = endSign[i]
          }
          for (let i = 0; i <= endSign.length; i++) {
            resultArr[startRow + 2][startCol - 1 + i] = endSign2[i]
          }

        }
        let result = "┌" + "─".repeat(this.width) + "┐\n"
          + "│" + (`score: ${this.snake.length - 2}`).padStart(this.width, " ") + "│\n"
          + "├" + "─".repeat(this.width) + "┤\n"
          + resultArr.map(row => "│" + row.join("") + "│").join("\n")
          + "\n└" + "─".repeat(this.width) + "┘\n";
        return result;
      }
      print() {
        console.log(this.toString())
      }
    }

    let game = new Game(20, 20);
    game.init();
    game.run();

    let pre = document.querySelector("pre");

    requestAnimationFrame(function update() {
      pre.textContent = game.toString()
      requestAnimationFrame(update)
    })

    document.addEventListener("keydown", function (e) {
      if (e.key.startsWith("Arrow")) {
        if (game.status == "play") {
          if (opposite[game.snake[0].direction] !== e.key.slice(5).toLowerCase()) {
            game.snake[0].direction = e.key.slice(5).toLowerCase();
            game.next();
            clearInterval(game.intervalID);
            game.run();
          }
        }
      }
      if (game.status == "over") {
        if (e.key == "Enter") {
          game.init();
          game.run();
        }
      }
    })

  </script>
</body>

</html>