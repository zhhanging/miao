<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Paint</title>
    <style>
      div.board {
        height: 500px;
        width: 500px;
        border: 1px solid red;
        position: relative;
      }
      .hidden {
        display: none;
      }
    </style>
  </head>

  <body>
    <div class="board">
      <svg
        version="1.1"
        baseProfile="full"
        width="500"
        height="500"
        xmlns="http://www.w3.org/2000/svg"
      ></svg>
    </div>
    <input type="color" name="color" id="pen-color" />
    <input
      type="range"
      name="stroke-width"
      id="stroke-width"
      min="1"
      max="20"
      value="5"
    />
    <label for="stroke-width"></label>

    <script>
      let svg = document.querySelector("svg");
      // svg.setAttribute("width", 1000)
      let penColor = document.querySelector("#pen-color");
      let strokeWidth = document.querySelector("#stroke-width");
      let strokeWidthLable = document.querySelector("label");

      let lastPos = null;

      strokeWidthLable.textContent = strokeWidth.value;

      strokeWidth.addEventListener("input", function (e) {
        strokeWidthLable.textContent = strokeWidth.value;
      });

      function draw(e) {
        // console.log(e);
        if (e.buttons == 0) {
          document.removeEventListener("mousemove", draw);
        } else {
          let pos = getReletivePos(svg);
          let line = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "line"
          );
          if (lastPos == null) {
            line.setAttribute("x1", pos.x);
            line.setAttribute("y1", pos.y);
          } else {
            line.setAttribute("x1", lastPos.x);
            line.setAttribute("y1", lastPos.y);
          }
          line.setAttribute("x2", pos.x);
          line.setAttribute("y2", pos.y);
          line.setAttribute("stroke", penColor.value);
          line.setAttribute("stroke-width", strokeWidth.value);
          line.setAttribute("stroke-linecap", "round");

          svg.append(line);

          lastPos = pos;
        }
      }

      svg.addEventListener("mousedown", function (e) {
        draw(e)
        document.addEventListener("mousemove", draw);
        document.addEventListener("mouseup", function reset() {
          lastPos = null;
          document.removeEventListener("mouseup", reset);
          document.removeEventListener("mousemove", draw);

          // 将一笔画的所有线放入一个 g 标签中，用以实现撤销功能
          let g = document.createElementNS("http://www.w3.org/2000/svg", "g");
          let lines = svg.querySelectorAll("svg > line");
          lines.forEach((node) => {
            g.appendChild(node);
          });
          svg.append(g);
        });
      });

      document.addEventListener("keydown", function (e) {
        let isMac =
          navigator.platform == "Mac68K" ||
          navigator.platform == "MacPPC" ||
          navigator.platform == "Macintosh" ||
          navigator.platform == "MacIntel";

        let control;
        if (isMac) {
          control = e.metaKey;
        } else {
          control = e.ctrlKey;
        }
        if (e.code == "KeyZ" && control && !e.shiftKey) {
          let groups = svg.querySelectorAll("svg > g:not(.hidden)");
          groups[groups.length - 1].classList.add("hidden");
        }
        // if (e.code == "KeyZ" && control && e.shiftKey) {
        //   let firstHidden = svg.querySelector("svg > g.hidden");
        //   firstHidden.classList.remove("hidden");
        // }
      });

      // 获取鼠标事件发生时鼠标相对元素的位置
      function getReletivePos(node) {
        let rect = node.getBoundingClientRect();
        return {
          x: window.event.clientX - rect.x,
          y: window.event.clientY - rect.y,
        };
      }
    </script>
  </body>
</html>
